#!/usr/bin/bash

set -e

CONFIG_DIR="$HOME/.config"
PACKAGES_DIR="$HOME/devenv/packages"
DOTFILES_DIR="$HOME/devenv"
PACKAGE_MANAGER="paru"

copy_dotfiles() {
    echo "[*] Copying dotfiles..."

    mkdir -p "$CONFIG_DIR"

    for item in "$DOTFILES_DIR"/dotfiles/*; do
        filename="$(basename "$item")"

        if [[ -d "$item" ]]; then
            target="$CONFIG_DIR/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing config directory or link: $target"
                rm -rf "$target"
            fi
            echo "[+] Copying $filename to $CONFIG_DIR"
            cp -r "$item" "$target"
        else
            target="$HOME/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing file or link: $target"
                rm -f "$target"
            fi
            echo "[+] Copying $filename to $HOME"
            cp "$item" "$target"
        fi
    done

    # Explicitly handle hidden files and directories
    for item in "$DOTFILES_DIR"/dotfiles/.*; do
        [[ "$(basename "$item")" == "." || "$(basename "$item")" == ".." ]] && continue

        filename="$(basename "$item")"

        if [[ -d "$item" ]]; then
            target="$HOME/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing hidden directory or link: $target"
                rm -rf "$target"
            fi
            echo "[+] Copying hidden directory $filename to $HOME"
            cp -r "$item" "$target"
        else
            target="$HOME/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing hidden file or link: $target"
                rm -f "$target"
            fi
            echo "[+] Copying hidden file $filename to $HOME"
            cp "$item" "$target"
        fi
    done

    echo "[✓] Dotfiles copied successfully."
}

link_dotfiles() {
    echo "[*] Creating symlinks for dotfiles..."

    mkdir -p "$CONFIG_DIR"

    for item in "$DOTFILES_DIR"/dotfiles/*; do
        filename="$(basename "$item")"

        if [[ -d "$item" ]]; then
            target="$CONFIG_DIR/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing config directory or link: $target"
                rm -rf "$target"
            fi
            echo "[+] Linking $filename to $CONFIG_DIR"
            ln -s "$item" "$target"
        else
            target="$HOME/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing file or link: $target"
                rm -f "$target"
            fi
            echo "[+] Linking $filename to $HOME"
            ln -s "$item" "$target"
        fi
    done

    # Handle hidden dotfiles as well
    for item in "$DOTFILES_DIR"/dotfiles/.*; do
        [[ "$(basename "$item")" == "." || "$(basename "$item")" == ".." ]] && continue

        filename="$(basename "$item")"

        if [[ -d "$item" ]]; then
            target="$HOME/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing hidden directory or link: $target"
                rm -rf "$target"
            fi
            echo "[+] Linking hidden directory $filename to $HOME"
            ln -s "$item" "$target"
        else
            target="$HOME/$filename"
            if [[ -e "$target" || -L "$target" ]]; then
                echo "[!] Removing existing hidden file or link: $target"
                rm -f "$target"
            fi
            echo "[+] Linking hidden file $filename to $HOME"
            ln -s "$item" "$target"
        fi
    done

    echo "[✓] Symlinks created successfully."
}

install_packages() {
    category="$1"

    case "$category" in
        base|dev|utility)
            script="$PACKAGES_DIR/$category.sh"
            if [[ -x "$script" ]]; then
                echo "[*] Running $script..."
                "$script"
            else
                echo "[X] Error: $script not found or not executable"
                exit 1
            fi
            ;;
        *)
            echo "[X] Invalid package category. Use: base, dev, or utility"
            exit 1
            ;;
    esac
}

list_packages() {
    category="$1"
    pkg_file="$PACKAGES_DIR/$category.sh"

    if [[ -f "$pkg_file" ]]; then
        echo "[*] Listing packages in category: $category"
        echo "-------------------------------------"

        packages=$(grep -E "^sudo pacman -S |^paru -S " "$pkg_file" |
                  sed 's/sudo pacman -S \(.*\) --noconfirm/\1/' |
                  sed 's/paru -S \(.*\) --noconfirm/\1/' |
                  sed 's/--needed //')

        while read -r pkg; do
            clean_pkg=$(echo "$pkg" | awk '{print $1}' | tr -d '-')

            if pacman -Qi "$clean_pkg" &>/dev/null || paru -Qi "$clean_pkg" &>/dev/null; then
                echo "$pkg [installed]"
            else
                echo "$pkg [not installed]"
            fi
        done <<< "$packages"

        echo "-------------------------------------"
    else
        echo "[!] Package list not found: $pkg_file"
        exit 1
    fi
}

# --- Main logic ---
case "$1" in
    copy)
        copy_dotfiles
        ;;
    link)
        link_dotfiles
        ;;
    install)
        if [[ -z "$2" ]]; then
            echo "[X] Please provide a package category: base, dev, or utility"
            exit 1
        fi
        install_packages "$2"
        ;;
    list)
        if [[ -z "$2" ]]; then
            echo "[X] Please provide a package category: base, dev, or utility"
            exit 1
        fi
        list_packages "$2"
        ;;
    *)
        echo "Usage: $0 {copy|link|install|list} [base|dev|utility]"
        exit 1
        ;;
esac

